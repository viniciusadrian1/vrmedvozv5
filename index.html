<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Med - Pulmão 3D com Chat Integrado</title>
  <meta name="description" content="AR Med - Visualização 3D e AR do pulmão com chat especializado integrado ao ambiente 3D.">
  <!-- Tailwind CSS via CDN -->
  <script defer src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <!-- Import map para resolver módulos ESM de Three.js -->
  <script type="importmap">
    {
      "imports": {
        "three": "/node_modules/three/build/three.module.js"
      }
    }
  </script>
</head>
<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden">
  <div id="app" class="flex h-screen">
    <!-- Área 3D -->
    <main class="relative flex-1">
      <div id="canvas-container" class="w-full h-full"></div>

      <!-- Barra superior -->
      <div class="absolute top-4 left-4 right-4 flex items-center gap-2" id="topControls">
        <div class="px-3 py-2 rounded bg-slate-800/70 backdrop-blur border border-slate-700 text-sm">
          <span class="font-semibold">AR Med</span> • Visualização 3D/AR do pulmão com Chat Integrado
        </div>
        <div class="ml-auto flex gap-2">
          <button id="resetCameraBtn" class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 text-sm">Resetar câmera</button>
          <button id="toggleAxesBtn" class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 text-sm">Linhas (eixos)</button>
          <button id="mouseModeBtn" class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 border border-slate-700 text-sm">Modo Mouse</button>
          <!-- O botão AR será injetado aqui -->
          <div id="arButtonContainer"></div>
        </div>
      </div>

      <!-- Instruções para AR -->
      <div id="arInstructions" class="absolute bottom-4 left-4 right-4 px-4 py-3 rounded bg-slate-800/90 backdrop-blur border border-slate-700 text-sm text-center hidden">
        <p>📱 O modelo 3D do pulmão e chat integrado aparecerão automaticamente à sua frente</p>
        <p class="text-xs mt-1 text-slate-400">Use os controles VR para interagir com o modelo e o chat 3D</p>
      </div>

      <!-- Status do Chat 3D (visível apenas em AR) -->
      <div id="arChatStatus" class="absolute top-20 right-4 px-3 py-2 rounded bg-emerald-800/90 backdrop-blur border border-emerald-700 text-sm hidden">
        <p class="text-emerald-100">💬 Chat 3D Ativo</p>
        <p class="text-xs text-emerald-200">Use controles VR para interagir</p>
      </div>
    </main>

    <!-- Painel de chat desktop - Visível apenas em modo desktop -->
    <aside class="w-[380px] max-w-[90vw] border-l border-slate-800 bg-slate-900/90 backdrop-blur p-4 flex flex-col gap-3" id="desktopChat">
      <div>
        <h1 class="text-lg font-semibold">Assistente Pulmonar</h1>
        <p class="text-xs text-slate-300">Especializado em pulmão e suas patologias.</p>
        <p class="text-xs text-slate-400 mt-1">Em AR: Chat integrado ao ambiente 3D</p>
      </div>

      <div id="chatMessages" class="flex-1 overflow-auto space-y-3 pr-1 custom-scroll"></div>

      <form id="chatForm" class="flex gap-2">
        <input id="chatInput" type="text" placeholder="Pergunte sobre pulmão e patologias..." class="flex-1 px-3 py-2 rounded bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500" required />
        
        <button id="recordBtn" type="button" class="px-3 py-2 rounded bg-red-600 hover:bg-red-500 text-white mr-2" title="Falar">
          🎤 Falar
        </button>
        <button id="sendBtn" type="submit" class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white">Enviar</button>
      </form>

      <!-- Informações sobre o chat 3D -->
      <div class="mt-2 p-2 rounded bg-slate-800/50 border border-slate-700">
        <p class="text-xs text-slate-400 mb-1">💡 Modo AR:</p>
        <p class="text-xs text-slate-300">• Chat aparece como painel 3D no ambiente</p>
        <p class="text-xs text-slate-300">• Use controles VR para interagir</p>
        <p class="text-xs text-slate-300">• Botão de microfone integrado</p>
      </div>
    </aside>
  </div>

  <script type="module" src="main.js"></script>
  <script defer src="chat.js"></script>

  <style>
    /* Melhorar contraste dos controles sobre o fundo da câmera */
    .absolute.top-4 > div {
      backdrop-filter: blur(12px) saturate(150%) !important;
      background: rgba(30, 41, 59, 0.9) !important;
      border: 1px solid rgba(51, 65, 85, 0.7) !important;
    }

    .absolute.top-4 button {
      backdrop-filter: blur(8px) !important;
      background: rgba(30, 41, 59, 0.95) !important;
      border: 1px solid rgba(51, 65, 85, 0.8) !important;
      transition: all 0.2s ease !important;
    }

    .absolute.top-4 button:hover {
      background: rgba(51, 65, 85, 0.95) !important;
      transform: translateY(-1px) !important;
    }

    /* Status do chat 3D */
    #arChatStatus {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.9; }
      50% { opacity: 0.7; }
    }

    /* Melhorar visibilidade das instruções AR */
    #arInstructions {
      backdrop-filter: blur(12px) saturate(150%) !important;
      background: rgba(30, 41, 59, 0.95) !important;
      border: 1px solid rgba(51, 65, 85, 0.7) !important;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4) !important;
    }

    /* Responsividade para dispositivos móveis */
    @media (max-width: 768px) {
      .absolute.top-4 {
        top: 0.5rem !important;
        left: 0.25rem !important;
        right: 0.25rem !important;
      }
      
      .absolute.top-4 > div,
      .absolute.top-4 button {
        font-size: 0.75rem !important;
        padding: 0.25rem 0.5rem !important;
      }
      
      #arChatStatus {
        top: 4rem !important;
        right: 0.25rem !important;
      }
      
      aside#desktopChat {
        width: 100vw !important;
        max-width: 100vw !important;
        position: fixed !important;
        bottom: 0 !important;
        top: auto !important;
        height: 50vh !important;
        border-left: none !important;
        border-top: 1px solid rgba(30, 41, 59, 0.8) !important;
        border-radius: 16px 16px 0 0 !important;
      }
    }

    /* Animações suaves */
    #arChatStatus {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    #arChatStatus.hidden {
      opacity: 0 !important;
      transform: translateX(100%) !important;
      pointer-events: none !important;
    }

    /* Garantir que funcione em modo alto contraste */
    @media (prefers-contrast: high) {
      #arChatStatus {
        background: rgba(0, 100, 0, 0.95) !important;
        border: 2px solid rgba(255, 255, 255, 0.8) !important;
        color: white !important;
      }
    }

    /* Reduzir animações para usuários que preferem menos movimento */
    @media (prefers-reduced-motion: reduce) {
      #arChatStatus {
        animation: none !important;
        transition: opacity 0.1s ease !important;
      }
      
      .absolute.top-4 button:hover {
        transform: none !important;
      }
    }
  </style>

  <script>
    // Sistema de controle do chat desktop vs AR
    let isInARMode = false;
    
    // Funções para gerenciar a interface
    function updateInterfaceForAR(arActive) {
      isInARMode = arActive;
      const desktopChat = document.getElementById('desktopChat');
      const arChatStatus = document.getElementById('arChatStatus');
      
      if (arActive) {
        // Modo AR ativo - ocultar chat desktop, mostrar status
        desktopChat.classList.add('hidden');
        arChatStatus.classList.remove('hidden');
        console.log('Interface atualizada para modo AR - Chat 3D ativo');
      } else {
        // Modo Desktop - mostrar chat desktop, ocultar status AR
        desktopChat.classList.remove('hidden');
        arChatStatus.classList.add('hidden');
        console.log('Interface atualizada para modo Desktop');
      }
    }

    // Escutar eventos de sessão XR
    document.addEventListener('DOMContentLoaded', () => {
      // Detectar início de sessão AR
      window.addEventListener('xrsessionstart', () => {
        console.log('Sessão AR iniciada - Ativando interface AR');
        setTimeout(() => updateInterfaceForAR(true), 500);
      });
      
      // Detectar fim de sessão AR
      window.addEventListener('xrsessionend', () => {
        console.log('Sessão AR finalizada - Voltando à interface desktop');
        setTimeout(() => updateInterfaceForAR(false), 500);
      });

      // Mostrar instruções específicas para chat 3D quando AR iniciar
      window.addEventListener('xrsessionstart', () => {
        const arInstructions = document.getElementById('arInstructions');
        if (arInstructions) {
          arInstructions.innerHTML = `
            <div style="background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; color: white;">
              <p>🎮 <strong>Chat 3D Integrado ao Ambiente AR:</strong></p>
              <p>• Procure pelo painel de chat 3D à sua esquerda</p>
              <p>• Botão 💬 para mostrar/ocultar o chat</p>
              <p>• Botão 🎤 para gravar mensagens de voz</p>
              <p>• Use os controles VR para interagir</p>
              <br>
              <p style="color: #10b981;">✨ Chat totalmente integrado ao ambiente 3D!</p>
            </div>
          `;
          arInstructions.classList.remove('hidden');
          
          setTimeout(() => {
            arInstructions.classList.add('hidden');
          }, 12000);
        }
      });

      console.log('Sistema de interface AR/Desktop carregado');
    });

    // Função global para adicionar mensagem (compatibilidade com chat.js)
    window.addARMessage = function(text, isUser = false) {
      // Em AR, as mensagens são gerenciadas pelo sistema 3D
      // Em desktop, usar o sistema tradicional
      if (!isInARMode) {
        const messagesContainer = document.getElementById('chatMessages');
        if (messagesContainer) {
          const messageDiv = document.createElement('div');
          messageDiv.className = isUser ? 'flex justify-end my-2' : 'flex justify-start my-2';
          
          const bubble = document.createElement('div');
          bubble.className = isUser 
            ? 'max-w-[85%] rounded-lg bg-emerald-700 text-white px-3 py-2 text-sm'
            : 'max-w-[85%] rounded-lg bg-gray-100 text-gray-900 px-3 py-2 text-sm';
          bubble.textContent = text;
          
          messageDiv.appendChild(bubble);
          messagesContainer.appendChild(messageDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          
          return messageDiv;
        }
      }
      return null;
    };

    // Função para verificar se está em modo AR
    window.isARMode = function() {
      return isInARMode;
    };
  </script>
</body>
</html>